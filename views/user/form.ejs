<%- include("../layout/navbar.ejs") %>

<!-- ========== MAIN ========== -->


<!-- Card Section -->
<div class="max-w-4xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14 mx-auto">
    
<form method="POST" action="/send-form" enctype="multipart/form-data">
        <!-- Card -->
        <div class="bg-white rounded-xl shadow">
            <div class="relative h-20 rounded-t-xl bg-no-repeat bg-cover bg-center" style="background-color: #388E3C;" >
                <div class="text-center">
                
                    <br>
                    <h2 class="text-2xl md:text-3xl font-bold text-white  ">
                        Formulir Permintaan Surat Keterangan Aktif Kuliah
                    </h2>
                    <br>
                </div>
            </div>

            <div class="pt-0 p-4 sm:pt-0 sm:p-7">
                <!-- Grid -->
                <div class="space-y-4 sm:space-y-6">
                    <div>
                        <div class="grid sm:flex sm:items-center sm:gap-x-5">
                            <div class="mt-4 sm:mt-auto sm:mb-1.5 flex justify-center sm:justify-start gap-2"></div>
                        </div>
                    </div>
                    

                    <% if (errors && errors.length > 0) { %>
                        <div class="mb-4 p-4 border-l-4 border-red-500 bg-red-100 text-red-700">
                          <ul class="list-disc pl-5 space-y-2">
                            <% errors.forEach(function(error) { %>
                              <li class="preline"><%= error.msg %></li>
                            <% }); %>
                          </ul>
                        </div>
                      <% } %>


                    <div class="space-y-2" id="nama">
                        <label for="af-submit-app-project-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NAMA LENGKAP MAHASISWA/I
                        </label>
                        <input style="display: none;" id="af-submit-project-url" name="inputName" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" value="<%=mahasiswa.nim %>">

                        <input id="af-submit-app-project-name" name="inputName" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" disabled value="<%=mahasiswa.name %>">
                    </div>
                    <div class="space-y-2" id="nim">
                        <label for="af-submit-project-url" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NOMOR INDUK MAHASISWA (NIM)
                        </label>
                        <input style="display: none;" id="af-submit-project-url" name="inputNim" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" value="<%=mahasiswa.nim %>">

                        <input id="af-submit-project-url"  type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" disabled value="<%=mahasiswa.nim %>">
                    </div>
                    <div class="space-y-2" id="Departemen">
                        <label for="af-submit-project-department" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            DEPARTEMEN
                        </label>
                        <input id="af-submit-project-department" name="inputDepartemen" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" disabled value="<%=mahasiswa.departemen %>">
                    </div>
                    
                    <div class="space-y-2">
                        <label for="af-submit-app-target" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            Target permintaan surat
                        </label>
                        <select id="af-submit-app-target" name="inputTarget" class="py-2 px-3 pe-9 block w-full border-gray-200 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
                            <option value="default" selected>Pilih target</option>
                            <option value="Pribadi">Pribadi</option>
                            <option value="Orang tua">Orang tua</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="af-submit-app-tujuan" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            Tujuan permintaan surat
                        </label>
                        <select id="af-submit-app-tujuan" name="inputTujuan" class="py-2 px-3 pe-9 block w-full border-gray-200 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
                            <option value="default" selected>Pilih tujuan</option>
                            
                        </select>
                    </div>
                    <div class="space-y-2" id="nama-orang-tua" style="display:none;">
                        <label for="af-submit-parent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NAMA ORANG TUA
                        </label>
                        <input id="af-submit-parent-name" name="inputOrtu" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" placeholder="Masukan Nama Orang Tua">
                    </div>
                    <div class="space-y-2" id="nip" style="display:none;">
                        <label for="af-submit-parent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NIP
                        </label>
                        <input id="af-submit-parent-name" name="inputNip" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" placeholder="Masukan NIP">
                    </div>
                    <div class="space-y-2" id="pangkat-golongan" style="display:none;">
                        <label for="af-submit-parent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            PANGKAT DAN GOLONGAN
                        </label>
                        <input id="af-submit-parent-name" name="inputPangkat" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" placeholder="Masukan Pangkat & Golongan">
                    </div>
                    <div class="space-y-2" id="unit-kerja" style="display:none;">
                        <label for="af-submit-parent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            UNIT KERJA
                        </label>
                        <input id="af-submit-parent-name" name="inputUnit" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" placeholder="Enter parent name">
                    </div>
                    <div class="space-y-2" id="instansi-induk" style="display:none;">
                        <label for="af-submit-parent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            INSTANSI INDUK
                        </label>
                        <input id="af-submit-parent-name" name="inputInstansi" type="text" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" placeholder="Enter parent name">
                    </div>

                    <div class="space-y-4" id="file">
                        <label for="af-submit-app-upload-images" class="inline-block text-sm font-medium text-gray-800 ">
                          UPLOAD BERKAS (SK Terakhir Orang Tua dan KRS Terakhir)
                        </label>
                      
                        <div class="relative group block p-4 sm:p-7 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer transition duration-150 ease-in-out hover:border-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2 ">
                          <input id="af-submit-app-upload-images" name="berkas" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="updateFileName()">
                          <div id="file-upload-icon" class="flex flex-col items-center justify-center h-full text-gray-400 ">
                            <svg class="h-10 w-10 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                              <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                              <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
                            </svg>
                            <span id="default-text" class="mt-2 block text-sm text-gray-800 ">
                              Browse your device or <span class="text-blue-600 group-hover:text-blue-700">drag 'n drop'</span>
                            </span>
                            <span id="file-name" class="hidden mt-2 block text-sm text-gray-800 "></span>
                            <span class="mt-1 block text-xs text-gray-500 dark:text-neutral-500">
                              Maximum file size is 2 MB
                            </span>
                          </div>
                        </div>
                      </div>
                </div>
                <!-- End Grid -->

                <div class="mt-5 flex justify-center gap-x-2">
                    <button type="submit" class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:pointer-events-none">
                        Submit
                    </button>
                </div>
            </div>
        </div>
        <!-- End Card -->
    </form>
  </div>
  <!-- End Card Section -->


  <%- include("../layout/footer.ejs") %>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const targetSelect = document.getElementById('af-submit-app-target');
        targetSelect.addEventListener('change', handleSelectChange);
  
        // Trigger change event to set initial state
        handleSelectChange();
  
        // Add event listener to the form to handle the submission
        const form = document.querySelector('form');
        const submitButton = form.querySelector('button[type="submit"]');
        const loadingIndicator = document.getElementById('loading-indicator'); // Assuming you have a loading indicator
  
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent the default form submission
  
            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());
            
            try {
                // Show loading indicator
                loadingIndicator.classList.remove('hidden');
                submitButton.disabled = true;
  
                const response = await fetch(form.action, {
                    method: form.method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formObject)
                });
  
                const result = await response.json();
  
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = '/riwayat';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: result.message
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Terjadi kesalahan',
                    text: 'Silakan coba lagi nanti.'
                });
            } finally {
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
            }
        });
    });
  
    function updateFileName() {
    const fileInput = document.getElementById('af-submit-app-upload-images');
    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
    const fileNameElement = document.getElementById('file-name');
    const defaultText = document.getElementById('default-text');

    if (fileName) {
      fileNameElement.textContent = fileName;
      fileNameElement.classList.remove('hidden');
      defaultText.classList.add('hidden');
    } else {
      fileNameElement.classList.add('hidden');
      defaultText.classList.remove('hidden');
    }
  }
  
    function handleSelectChange() {
        const targetSelect = document.getElementById('af-submit-app-target');
        const tujuanSelect = document.getElementById('af-submit-app-tujuan');
        
        const tujuanOptions = {
            default: [{ value: 'default', text: 'Pilih tujuan' }],
            Pribadi: [{ value: 'Beasiswa', text: 'Beasiswa' }],
            'Orang tua': [
                { value: 'Tunjangan orang tua', text: 'Tunjangan orang tua' },
                { value: 'Taspen', text: 'Taspen' },
                { value: 'BPJS', text: 'BPJS' }
            ]
        };
  
        const selectedTarget = targetSelect.value;
        const options = tujuanOptions[selectedTarget] || tujuanOptions['default'];
        
        tujuanSelect.innerHTML = '';
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.text = option.text;
            tujuanSelect.appendChild(opt);
        });
  
        // Handle display of additional fields
        const untuk = document.getElementById('untuk');
        const namaOrangTua = document.getElementById('nama-orang-tua');
        const nip = document.getElementById('nip');
        const pangkatGolongan = document.getElementById('pangkat-golongan');
        const unitKerja = document.getElementById('unit-kerja');
        const instansiInduk = document.getElementById('instansi-induk');
  
        if (selectedTarget === 'Orang tua') {
            namaOrangTua.style.display = 'block';
            nip.style.display = 'block';
            pangkatGolongan.style.display = 'block';
            unitKerja.style.display = 'block';
            instansiInduk.style.display = 'block';
            file.style.display = 'block';
        } else {
            untuk.style.display = 'none';
            namaOrangTua.style.display = 'none';
            nip.style.display = 'none';
            pangkatGolongan.style.display = 'none';
            unitKerja.style.display = 'none';
            instansiInduk.style.display = 'none';
        }
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/preline/preline.js"></script>

</body>
</html>